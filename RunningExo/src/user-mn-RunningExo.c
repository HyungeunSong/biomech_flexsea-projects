/****************************************************************************
	[Project] FlexSEA: Flexible & Scalable Electronics Architecture
	[Sub-project] 'user/ActPack' DDephy's Actuator Package (ActPack)
	Copyright (C) 2017 Dephy, Inc. <http://dephy.com/>
*****************************************************************************
	[Lead developper] Jean-Francois Duval, jfduval at dephy dot com.
	[Origin] Based on Jean-Francois Duval's work at the MIT Media Lab
	Biomechatronics research group <http://biomech.media.mit.edu/>
	[Contributors]
*****************************************************************************
	[This file] user-mn-ActPack: User code running on Mn
****************************************************************************
	[Change log] (Convention: YYYY-MM-DD | author | comment)
	* 2017-09-27 | jfduval | Initial release
	*
****************************************************************************/


#if defined INCLUDE_UPROJ_RUNNINGEXO || defined BOARD_TYPE_FLEXSEA_PLAN
#if defined BOARD_TYPE_FLEXSEA_MANAGE || defined BOARD_TYPE_FLEXSEA_PLAN

//Un-comment the next line to enable manual control from the GUI:
//#define MANUAL_GUI_CONTROL

//****************************************************************************
// Include(s)
//****************************************************************************
//#include "stdbool.h"
//#include <math.h>
#include "user-mn.h"
#include "user-mn-ActPack.h"
#include "flexsea_sys_def.h"
#include "flexsea_user_structs.h"
//#include "flexsea_global_structs.h"
#include <flexsea_system.h>
#include "flexsea_cmd_calibration.h"
#include <flexsea_comm.h>
//#include "flexsea_board.h"
//#include "user-mn-Rigid.h"
//#include "cmd-ActPack.h"
//#include "cmd-Rigid.h"
#include "user-mn-RunningExo.h"


//----------------------------------------------------------------------------
// Local Variable(s) and Struct
//----------------------------------------------------------------------------
int16_t fsm1State;
float torqueProfileGain = DEFAULT_TORQUE_PROFILE_GAIN;
int8_t bodyWeight = DEFAULT_BODY_WEIGHT;//user body weight (kg)
float controlAction;
float currentScalar = CURRENT_SCALAR_INIT;

//initialize one instance
struct runningExoSystemState runningExoState =
{.state=0,.prevStanceDuration=0,.timer=0,.pedometer=0,.heelStrikeTime=0,.toeOffTime=0, .enableOutput=0, .running=1, .prevGaitDuration=0, .footFlatTime=0};	//zero initialization


//****************************************************************************
// Trajectory lookup table(s)
//****************************************************************************
#ifdef RUNNING_TORQUE_TRACKING
	static const float unitRunningTorque[TABLE_SIZE] =
	{0.0000986168980059432,0.00189588334406876,0.00351085920888583,0.00495568656342874,0.00624250747866906,0.00738346402557836,0.00839069827512822,0.00927635229829022,0.0100525681660359,0.0107314879493369,0.0113252537191648,0.0118460075464911,0.0123058915022874,0.0127170476575253,0.0130916180831764,0.0134417448502122,0.0137795700296044,0.0141172356923244,0.0144668839093439,0.0148406567516344,0.0152506962901676,0.0157091445959150,0.0162281437398481,0.0168198357929386,0.0174963628261580,0.0182698669104780,0.0191524901168700,0.0201563745163056,0.0212936621797565,0.0225764951781942,0.0240170155825902,0.0256273654639163,0.0274196868931438,0.0294061219412445,0.0315988126791898,0.0340099011779514,0.0366515295085009,0.0395358397418097,0.0426749739488495,0.0460810742005919,0.0497662825680085,0.0537427411220707,0.0580225919337502,0.0626179770740187,0.0675410386138475,0.0728039186242084,0.0784187591760729,0.0843977023404125,0.0907528901881988,0.0974964647904035,0.104640568217998,0.112197342541954,0.120178271300305,0.128578899710185,0.137378381804291,0.146555122487390,0.156087526664249,0.165953999239633,0.176132945118308,0.186602769205041,0.197341876404599,0.208328671621746,0.219541559761249,0.230958945727875,0.242559234426390,0.254320830761559,0.266222139638149,0.278241565960926,0.290357514634657,0.302548390564107,0.314792598654042,0.327068543809230,0.339357521227539,0.351657755141927,0.363973614675531,0.376309477605366,0.388669721708449,0.401058724761795,0.413480864542419,0.425940518827338,0.438442065393568,0.450989882018124,0.463588346478022,0.476241836550277,0.488954730011907,0.501731404639925,0.514576238211349,0.527493608503194,0.540487893292475,0.553563470356209,0.566724717471411,0.579976012415097,0.593321732964283,0.606766256895985,0.620313961987218,0.633969226014998,0.647736426756341,0.661619006510945,0.675609672798573,0.689694273444659,0.703858544874067,0.718088223511658,0.732369045782296,0.746686748110843,0.761027066922162,0.775375738641115,0.789718499692566,0.804041086501377,0.818329235492411,0.832568683090530,0.846745165720597,0.860844419807476,0.874852181776028,0.888754188051117,0.902536175057604,0.916183879220354,0.929683036964228,0.943019384714089,0.956178736759766,0.969161793513334,0.982001705358033,0.994735897512698,1.00740179519617,1.02003682362727,1.03267840802485,1.04536397360773,1.05813094559476,1.07101674920477,1.08405880965659,1.09729455216906,1.11076140196102,1.12449678425130,1.13853812425873,1.15292284720216,1.16768837830041,1.18287025208032,1.19843389813115,1.21425559442604,1.23020584979698,1.24615517307594,1.26197407309486,1.27753305868574,1.29270263868052,1.30735332191118,1.32135561720969,1.33458013889583,1.34694679862025,1.35850317296605,1.36931723251167,1.37945694783556,1.38899028951614,1.39798522813185,1.40650973426113,1.41463177848242,1.42241933137416,1.42994036351478,1.43726284548271,1.44445474785641,1.45158404121430,1.45871869613482,1.46592668319641,1.47327597297750,1.48083402462649,1.48863520386234,1.49666114711331,1.50488878305300,1.51329504035500,1.52185684769291,1.53055113374032,1.53935482717083,1.54824485665803,1.55719815087552,1.56619163849689,1.57520224819573,1.58420690864566,1.59318254852024,1.60210609649310,1.61095448123780,1.61970463142797,1.62833375971129,1.63682565324323,1.64517069772254,1.65335956762927,1.66138293744347,1.66923148164516,1.67689587471441,1.68436679113124,1.69163490537570,1.69869089192782,1.70552542526766,1.71212917987525,1.71849283023063,1.72460705081385,1.73046251610494,1.73604990058395,1.74135987873092,1.74638312502588,1.75111140801839,1.75554667913327,1.75969642665147,1.76356819414620,1.76716952519065,1.77050796335806,1.77359105222161,1.77642633535453,1.77902135633002,1.78138365872130,1.78352078610156,1.78544028204402,1.78714969012189,1.78865655390838,1.78996841697669,1.79109282290005,1.79203731525165,1.79280943760470,1.79341673353242,1.79386674660801,1.79416701912880,1.79432418367903,1.79434236519800,1.79422526023931,1.79397656535659,1.79359997710342,1.79309919203344,1.79247790670023,1.79173981765742,1.79088862145861,1.78992801465740,1.78886169380741,1.78769335546225,1.78642669617553,1.78506541250084,1.78361320099181,1.78207375820204,1.78045078068514,1.77874796499472,1.77696900768438,1.77511760530774,1.77319601400590,1.77117347447419,1.76898627519470,1.76656927688354,1.76385734025682,1.76078532603066,1.75728809492117,1.75330050764445,1.74875742491663,1.74359370745381,1.73774421597210,1.73114381118762,1.72372735381648,1.71542970457478,1.70618572417865,1.69593027334419,1.68459821278751,1.67212440322473,1.65844370537196,1.64350645248314,1.62741256566740,1.61034580505813,1.59249085522577,1.57403240074073,1.55515512617345,1.53604371609436,1.51688285507388,1.49785722768243,1.47915151849045,1.46094874420830,1.44334353933061,1.42629987525612,1.40977119208057,1.39371092989969,1.37807252880922,1.36280942890488,1.34787507028243,1.33322289303759,1.31880633726609,1.30457884306367,1.29049385052607,1.27650479974901,1.26256513082825,1.24862828385949,1.23464769893850,1.22057747430125,1.20640862973237,1.19218798432697,1.17796699389316,1.16379711423901,1.14972980117265,1.13581651050217,1.12210869803566,1.10865781958123,1.09551533094698,1.08273268794100,1.07034772347902,1.05834191535684,1.04668217087989,1.03533539733374,1.02426850200396,1.01344839217611,1.00284197513578,0.992416158168536,0.982137848559946,0.971973953595583,0.961891380561020,0.951857036741829,0.941837829423581,0.931803485239441,0.921743082192189,0.911653822680988,0.901532937031521,0.891377655569472,0.881185208620527,0.870952826510368,0.860677739564681,0.850357178109147,0.839988372469454,0.829568552971283,0.819094949940320,0.808564793702247,0.797975314582750,0.787323742907512,0.776607309002217,0.765823243192551,0.754967876305508,0.744032651600701,0.733007360197063,0.721881791916672,0.710645736581605,0.699288984013940,0.687801324035753,0.676172546469125,0.664392441136131,0.652450797858850,0.640337406459358,0.628042056759734,0.615554538582056,0.602864641748400,0.589964668453094,0.576866170990819,0.563589603936411,0.550155470082218,0.536584272220589,0.522896513143873,0.509112695644419,0.495253322514578,0.481338896546697,0.467389920533126,0.453426897266215,0.439470761480430,0.425552661381807,0.411714115982368,0.397997107705444,0.384443618974369,0.371095632212471,0.357995129843083,0.345184094289538,0.332704507975165,0.320598353323297,0.308907612757265,0.297674268700399,0.286940303576033,0.276747699807497,0.267137573659985,0.258113256282491,0.249626472908070,0.241625233978745,0.234057549936542,0.226871431223486,0.220014888281602,0.213435931552916,0.207082571479451,0.200902818503234,0.194844683066289,0.188856175610641,0.182885306578317,0.176880086411339,0.170788877001122,0.164589065553834,0.158308306822715,0.151979261416470,0.145634589943804,0.139306953013420,0.133029011234023,0.126833425214315,0.120752855563002,0.114819962888788,0.109067407800375,0.103527850906469,0.0982339528157733,0.0932183741369914,0.0885137754788281,0.0841528174499867,0.0801681606591715,0.0765924657150868,0.0734572066327729,0.0707596893082298,0.0684587289097377,0.0665110856425686,0.0648735197119951,0.0635027913232892,0.0623556606817231,0.0613888879925694,0.0605592334611001,0.0598234572925875,0.0591383196923039,0.0584605808655216,0.0577470010175129,0.0569543403535499,0.0560393590789050,0.0549588173988505,0.0536709214673461,0.0521648677032763,0.0504596335646497,0.0485754004928964,0.0465323499294468,0.0443506633157314,0.0420505220931801,0.0396521077032234,0.0371756015872918,0.0346411851868151,0.0320690399432240,0.0294793472979485,0.0268922886924190,0.0243280455680660,0.0218067993663195,0.0193487315286098,0.0169740234963675,0.0147028567110225,0.0125554126140054,0.0105501017918099,0.00869030995966098,0.00697184811363641,0.00539046931128616,0.00394192661016060,0.00262197306781002,0.00142636174178447,0.000350845689634255,0.000608822031090334,0.00145688836283922,0.00219760024806206,0.00283520462920875,0.00337394844872900,0.00381807864907256,0.00417184217268930,0.00443948596202893,0.00462525695954125,0.00473340210767605,0.00476816834888310,0.00473380262561219,0.00463455188031309,0.00447466305543560,0.00425838309342947,0.00398995893674450,0.00367363752783050,0.00331366580913717,0.00291429072311435,0.00247975921221185,0.00201431821887937,0.00152221468556676,0.00100769555472375,0.000475007768800136,0.0000716017297542563,0.000627885998489730,0.00118959809495645,0.00175249107670461,0.00231231800128450,0.00286483192624630,0.00340578590914021,0.00393093300751649,0.00443602627892533,0.00491681878091698,0.00536906357104163,0.00578876294932376,0.00617507359454374,0.00652931631198078,0.00685285424302076,0.00714705052904962,0.00741326831145323,0.00765287073161753,0.00786722093092839,0.00805768205077171,0.00822561723253341,0.00837238961759938,0.00849936234735552,0.00860789856318773,0.00869936140648192,0.00877511401862399,0.00883651954099983,0.00888494111499535,0.00892174188199646,0.00894828498338905,0.00896593356055901,0.00897605075489227,0.00897999970777471,0.00897914356059223,0.00897484545473075,0.00896846853157615,0.00896137593251435,0.00895493079893123,0.00895049627221272,0.00894943549374469,0.00895311160491306,0.00896288774710373,0.00898012706170260,0.00900619269009557,0.00904244777366854,0.00909025545380741,0.00915097887189809,0.00922598116932646,0.00931662548747845,0.00942427496773995,0.00955029275149685,0.00969604198013507,0.00986288579504049,0.0100521467032544,0.0102640672349521,0.0104977224091988,0.0107521290705264,0.0110263040634665,0.0113192642325507,0.0116300264223110,0.0119576074772789,0.0123010242419862,0.0126592935609647,0.0130314322787460,0.0134164572398619,0.0138133852888442,0.0142212332702244,0.0146390180285344,0.0150657564083059,0.0155004652540705,0.0159421614103601,0.0163898617217063,0.0168425830326409,0.0172993421876957,0.0177591560314022,0.0182210414082923,0.0186840151628976,0.0191470941397499,0.0196092951833810,0.0200696351383225,0.0205271308491062,0.0209807991602638,0.0214296569163269,0.0218727209618275,0.0223090081412970,0.0227375352992674,0.0231573192802703,0.0235673769288374,0.0239667250895005,0.0243543806067913,0.0247293603252414,0.0250906811123565,0.0254375865223285,0.0257701034348857,0.0260884278081043,0.0263927556000603,0.0266832827688298,0.0269602052724889,0.0272237190691136,0.0274740201167801,0.0277113043735643,0.0279357677975423,0.0281476063467903,0.0283470159793843,0.0285341926534004,0.0287093323269146,0.0288726309580030,0.0290242845047417,0.0291644889252067,0.0292934401774742,0.0294113342196202,0.0295183670097207,0.0296147345058519,0.0297006326660898,0.0297762574485106,0.0298418048111901,0.0298974707122046,0.0299434511096301,0.0299799419615427,0.0300071392260184,0.0300252388611334,0.0300344368249636,0.0300349290755852,0.0300269115710743,0.0300105802695068,0.0299861311289589,0.0299537601075067,0.0299136631632262,0.0298660362541935,0.0298110753384847,0.0297489763741758,0.0296799353193429,0.0296041481320621,0.0295218107704094,0.0294331277767819,0.0293383537534241,0.0292377613984465,0.0291316234346786,0.0290202125849501,0.0289038015720907,0.0287826631189297,0.0286570699482970,0.0285272947830221,0.0283936103459345,0.0282562893598639,0.0281156045476399,0.0279718286320920,0.0278252343360499,0.0276760943823432,0.0275246814938015,0.0273712683932544,0.0272161278035314,0.0270595324474622,0.0269017550478764,0.0267430683276035,0.0265837450094732,0.0264240578163151,0.0262642794709588,0.0261046826962339,0.0259455402149699,0.0257871247499965,0.0256297090241432,0.0254735657602398,0.0253189676811157,0.0251661875096005,0.0250154979685240,0.0248671717807156,0.0247214816690050,0.0245787003562217,0.0244391005651954,0.0243029550187557,0.0241705364397322,0.0240421175509544,0.0239179710752520,0.0237983697354546,0.0236835862543917,0.0235738933548930,0.0234695637597880,0.0233708701919065,0.0232780853740779,0.0231914403805989,0.0231109725702551,0.0230366630238343,0.0229684928159742,0.0229064430213123,0.0228504947144863,0.0228006289701337,0.0227568268628921,0.0227190694673991,0.0226873378582923,0.0226616131102091,0.0226418762977873,0.0226281084956644,0.0226202907784779,0.0226184042208655,0.0226224298974647,0.0226323488829132,0.0226481422518483,0.0226697910789079,0.0226972764387294,0.0227305794059504,0.0227696810552085,0.0228145624611413,0.0228652046983863,0.0229215888415812,0.0229836959653635,0.0230515071443707,0.0231250034532405,0.0232041659666105,0.0232889757591182,0.0233794139054012,0.0234754614800971,0.0235770995578434,0.0236843092132777,0.0237970715210377,0.0239153675557609,0.0240391783920848,0.0241684851046471,0.0243032687680853,0.0244435104570370,0.0245891912461398,0.0247402922100313,0.0248967944233490,0.0250586789607305,0.0252259268968135,0.0253985193062354,0.0255764372636338,0.0257596618436464,0.0259481741209107,0.0261419551700643,0.0263409860657447,0.0265452478825897,0.0267547216952366,0.0269693885783231,0.0271892296064868,0.0274142258543653,0.0276443583965961,0.0278796083078169,0.0281199566626651,0.0283653845357784,0.0286158730017944,0.0288714031353505,0.0291319560110845,0.0293975127036339,0.0296680542876362,0.0299435618377291,0.0302240164285502,0.0305093876357325,0.0307993426730028,0.0310932237155208,0.0313903568966727,0.0316900683498447,0.0319916842084231,0.0322945306057942,0.0325979336753442,0.0329012195504595,0.0332037143645261,0.0335047442509305,0.0338036353430589,0.0340997137742975,0.0343923056780326,0.0346807371876504,0.0349643344365373,0.0352424235580795,0.0355143306856632,0.0357793819526747,0.0360369034925003,0.0362862214385262,0.0365266619241386,0.0367575510827240,0.0369782150476684,0.0371879799523582,0.0373861719301796,0.0375721171145189,0.0377451416387624,0.0379045716362962,0.0380497332405068,0.0381799525847802,0.0382945558025029,0.0383928690270610,0.0384742183918408,0.0385379300302285,0.0385833300756106,0.0386097446613731,0.0386164999209023,0.0386029219875846,0.0385683369948062,0.0385120710759532,0.0384334503644121,0.0383318009935691,0.0382064490968103,0.0380567208075222,0.0378819422590908,0.0376814395849026,0.0374545389183437,0.0372005663928005,0.0369188481416591,0.0366087102983059,0.0362694789961271,0.0359004803685089,0.0355014793761439,0.0350740509765732,0.0346202367217312,0.0341420781640362,0.0336416168559066,0.0331208943497608,0.0325819521980172,0.0320268319530939,0.0314575751674097,0.0308762233933826,0.0302848181834310,0.0296854010899735,0.0290800136654283,0.0284706974622137,0.0278594940327482,0.0272484449294501,0.0266395917047376,0.0260349759110294,0.0254366391007437,0.0248466228262987,0.0242669686401131,0.0236997180946050,0.0231469127421928,0.0226105941352949,0.0220928038263298,0.0215955833677155,0.0211209743118708,0.0206710182112138,0.0202477566181628,0.0198532310851364,0.0194894831645528,0.0191585544088304,0.0188624863703876,0.0186033206016427,0.0183830986550141,0.0182038620829201,0.0180676524377792,0.0179765112720097,0.0179324801380299,0.0179376005882582,0.0179939141751129,0.0181034624510126,0.0182682869683754,0.0184897761729403,0.0187654718194420,0.0190915120933543,0.0194640331268899,0.0198791710522612,0.0203330620016810,0.0208218421073618,0.0213416475015163,0.0218886143163571,0.0224588786840967,0.0230485767369478,0.0236538446071232,0.0242708184268352,0.0248956343282965,0.0255244284437200,0.0261533369053179,0.0267784958453030,0.0273960413958880,0.0280021096892853,0.0285928368577077,0.0291643590333679,0.0297128123484782,0.0302343329352514,0.0307250569259002,0.0311811204526371,0.0315986596476747,0.0319738106432257,0.0323027095715026,0.0325814925647181,0.0328062957550848,0.0329732552748153,0.0330785072561222,0.0331181878312182,0.0330884331323158,0.0329854015919046,0.0328099950807260,0.0325737064664536,0.0322894628514409,0.0319701913380415,0.0316288190286088,0.0312782730254964,0.0309314804310579,0.0306013683476467,0.0303008638776163,0.0300428941233203,0.0298403861871123,0.0297062671713456,0.0296534641783739,0.0296949043105506,0.0298435146702294,0.0301122223597636,0.0305139544815068,0.0310616381378127,0.0317682004310346,0.0326465684635260,0.0337096693376407,0.0349704301557319,0.0364398657544927,0.0381097409404775,0.0399606837960254,0.0419731867538231,0.0441277422465577,0.0464048427069153,0.0487849805675828,0.0512486482612472,0.0537763382205945,0.0563485428783118,0.0589457546670862,0.0615484660196034,0.0641371693685507,0.0666923571466150,0.0691945217864822,0.0716241557208395,0.0739617513823734,0.0761878012037711,0.0782827976177185,0.0802272330569027,0.0820016043049008,0.0835917425276527,0.0849991936380418,0.0862283830122452,0.0872837360264393,0.0881696780568012,0.0888906344795076,0.0894510306707356,0.0898552920066617,0.0901078438634630,0.0902131116173163,0.0901755206443984,0.0899994963208862,0.0896894640229565,0.0892498491267861,0.0886850770085520,0.0879995730444308,0.0871977626105996,0.0862840710832352,0.0852629238385143,0.0841387462526139,0.0829159637017108,0.0815990015619816,0.0801922852096036,0.0787002400207535,0.0771272913716078,0.0754778646383438,0.0737563851971382,0.0719679825786879,0.0701213588513726,0.0682263463305218,0.0662927777751720,0.0643304859443608,0.0623493035971249,0.0603590634925012,0.0583695983895265,0.0563907410472383,0.0544323242246732,0.0525041806808679,0.0506161431748600,0.0487780444656861,0.0469997173123830,0.0452909944739880,0.0436617087095381,0.0421216926344904,0.0406784756967102,0.0393314459906160,0.0380781935910911,0.0369163085730191,0.0358433810112833,0.0348570009807671,0.0339547585563537,0.0331342438129267,0.0323930468253695,0.0317287576685652,0.0311389664173975,0.0306212631467497,0.0301732379315051,0.0297924808465471,0.0294765819667592,0.0292231313670246,0.0290297191222268,0.0288939353072492,0.0288133699969751,0.0287856132662880,0.0288082551900711,0.0288788858432080,0.0289950953005819,0.0291544736370763,0.0293546109275746,0.0295930972469601,0.0298675226701161,0.0301754772719262,0.0305145511272737,0.0308823343110419,0.0312764168981143,0.0316943889633742,0.0321338405817050,0.0325923618279901,0.0330675427771130,0.0335569735039568,0.0340582440834051,0.0345689445903413,0.0350866650996486,0.0356089956862105,0.0361335264249105,0.0366578473906317,0.0371795486582578,0.0376962203026719,0.0382054523987576,0.0387048350213982,0.0391919582454770,0.0396644121458775,0.0401197867974831,0.0405556722751770,0.0409696586538429,0.0413593360083638,0.0417222944136234,0.0420561239445050,0.0423584146758918,0.0426267566826674,0.0428587400397152,0.0430519548219184,0.0432039911041605,0.0433124389613248,0.0433748884682948,0.0433889296999539,0.0433521527311853,0.0432621476368726,0.0431165044918990,0.0429128133711480,0.0426486643495029,0.0423216475018472,0.0419293529030641,0.0414693706280372,0.0409392907516497,0.0403367033487852,0.0396591984943268,0.0389043662631581};

	#endif

#ifdef WALKING_TORQUE_TRACKING

	static const float unitWalkingTorque[TABLE_SIZE] =
	{0,0.00159519929671226,0.00307050851286351,0.00442958767606983,0.00567609681394731,0.00681369595411204,0.00784604512418008,0.00877680435176754,0.00960963366449049,0.0103481930899650,0.0109961426558072,0.0115571423896331,0.0120348523190589,0.0124329324717006,0.0127550428751742,0.0130048435570960,0.0131859945450819,0.0133021558667481,0.0133569875497106,0.0133541496215855,0.0132973021099889,0.0131901050425369,0.0130362184468455,0.0128393023505309,0.0126030167812092,0.0123310217664964,0.0120269773340085,0.0116945435113618,0.0113373803261722,0.0109591478060559,0.0105635059786289,0.0101541148715074,0.00973463451230729,0.00930872492864483,0.00888004614813604,0.00845225819839701,0.00802902110704382,0.00761399490169256,0.00721083960995930,0.00682321525946014,0.00645478187781116,0.00610919949262843,0.00579012813152805,0.00550122782212610,0.00524615859203867,0.00502858046888183,0.00485215348027166,0.00472053765382427,0.00463739301715572,0.00460637959788210,0.00463115742361950,0.00471538652198400,0.00486272692059169,0.00507683864705864,0.00536138172900093,0.00572001619403467,0.00615617535175449,0.00667137032334175,0.00726614375693612,0.00794103090967990,0.00869656703871534,0.00953328740118473,0.0104517272542303,0.0114524218549944,0.0125359064606193,0.0137027163282472,0.0149533867150204,0.0162884528780812,0.0177084500745719,0.0192139135616347,0.0208053785964119,0.0224833804360458,0.0242484543376786,0.0261011355584527,0.0280419593555103,0.0300714609859936,0.0321901757070450,0.0343986387758068,0.0366973854494211,0.0390869509850303,0.0415678706397767,0.0441406796708025,0.0468059133352500,0.0495641068902615,0.0524157955929792,0.0553610690523668,0.0583960884566969,0.0615149710431832,0.0647118165128810,0.0679807245668457,0.0713157949061326,0.0747111272317970,0.0781608212448944,0.0816589766464799,0.0851996931376090,0.0887770704193370,0.0923852081927193,0.0960182061588110,0.0996701640186677,0.103335181473345,0.107007358223897,0.110680793971381,0.114349588416850,0.118007841261361,0.121649652205970,0.125269120951730,0.128860347199698,0.132417430650929,0.135934471006478,0.139405567967401,0.142824821234752,0.146186330509588,0.149484195492964,0.152712515885935,0.155865391389555,0.158936921704882,0.161921206532969,0.164812345574873,0.167604439228397,0.170293739870585,0.172883408572237,0.175377990029789,0.177782028939681,0.180100069998348,0.182336657902230,0.184496337347764,0.186583653031388,0.188603149649538,0.190559371898654,0.192456864475172,0.194300172075531,0.196093839396168,0.197842411133521,0.199550431984027,0.201222446644125,0.202862999810251,0.204476636178844,0.206067900446342,0.207641337309181,0.209201491463800,0.210752907606637,0.212300130434129,0.213847704642714,0.215399779118750,0.216956982410489,0.218518098034395,0.220081893263857,0.221647135372265,0.223212591633012,0.224777029319487,0.226339215705080,0.227897918063183,0.229451903667186,0.230999939790479,0.232540793706453,0.234073232688498,0.235596024010006,0.237107934944366,0.238607732764970,0.240094184745207,0.241566058158469,0.243022120278145,0.244461138377627,0.245881879730305,0.247283111609569,0.248663601288811,0.250022116041420,0.251357423140787,0.252668289860303,0.253953483473359,0.255211771253344,0.256441920473650,0.257642698407667,0.258812872328785,0.259951209510396,0.261056477225889,0.262127442851284,0.263163807435901,0.264168484872879,0.265145079600783,0.266097196058179,0.267028438683633,0.267942411915710,0.268842720192976,0.269732967953996,0.270616759637335,0.271497699681560,0.272379392525235,0.273265442606927,0.274159454365201,0.275065032238622,0.275985780665756,0.276925304085169,0.277887206935426,0.278875093655092,0.279892568682733,0.280943236456915,0.282030701416204,0.283158567999164,0.284330440644361,0.285549923790361,0.286820621875729,0.288146139339032,0.289530080618834,0.290976050153700,0.292487652382198,0.294068491742891,0.295722172674346,0.297452299615128,0.299262477003803,0.301156309278936,0.303137400879092,0.305209356242838,0.307375779808739,0.309640276015360,0.312005874854270,0.314469138925073,0.317022556167523,0.319658550874275,0.322369547337988,0.325147969851316,0.327986242706916,0.330876790197446,0.333812036615561,0.336784406253918,0.339786323405174,0.342810212361985,0.345848497417008,0.348893602862898,0.351937952992313,0.354973972097910,0.357994084472344,0.360990714408272,0.363956286198350,0.366883224135236,0.369763952511585,0.372590895620055,0.375356477753301,0.378053123203981,0.380673256264750,0.383209301228265,0.385653682387183,0.387998824034160,0.390237150461853,0.392361763909293,0.394373435836305,0.396277786789925,0.398080513810319,0.399787313937654,0.401403884212097,0.402935921673814,0.404389123362972,0.405769186319736,0.407081807584275,0.408332684196754,0.409527513197340,0.410671991626200,0.411771816523499,0.412832684929406,0.413860293884085,0.414860340427704,0.415838521600430,0.416800534442429,0.417752075993867,0.418698843294911,0.419646533385727,0.420600843306483,0.421567470097345,0.422552110798479,0.423560462450051,0.424598222092229,0.425671086765180,0.426784753509068,0.427944919364062,0.429157281370328,0.430427536568032,0.431761381997341,0.433164514698421,0.434642631711439,0.436201430076562,0.437846606833956,0.439583838189175,0.441415883063629,0.443339607834031,0.445351169104543,0.447446723479330,0.449622427562553,0.451874437958378,0.454198911270966,0.456592004104481,0.459049873063087,0.461568674750946,0.464144565772223,0.466773702731080,0.469452242231681,0.472176340878189,0.474942155274767,0.477745842025578,0.480583557734787,0.483451459006556,0.486345702445048,0.489262444654427,0.492197842238856,0.495148051802499,0.498109229949518,0.501077533284077,0.504049118410340,0.507020141932469,0.509986760454628,0.512945130580980,0.515891408915689,0.518821752062918,0.521732316626829,0.524619259211588,0.527478736421355,0.530306904860296,0.533100173251904,0.535858438915583,0.538584146543797,0.541279798849992,0.543947898547612,0.546590948350103,0.549211450970908,0.551811909123474,0.554394825521245,0.556962702877665,0.559518043906181,0.562063351320236,0.564601127833276,0.567133876158746,0.569664099010091,0.572194299100755,0.574726979144184,0.577264641853822,0.579809789943114,0.582364926125506,0.584932553114442,0.587515173623367,0.590115290365726,0.592735406054964,0.595378023404526,0.598045645127857,0.600740773938402,0.603465912549606,0.606223563674913,0.609016230027769,0.611846414321619,0.614716619269907,0.617629347586078,0.620587101983578,0.623592385175770,0.626646684268497,0.629747476230786,0.632891248402928,0.636074488125212,0.639293682737929,0.642545319581369,0.645825885995824,0.649131869321582,0.652459756898935,0.655806036068174,0.659167194169588,0.662539718543467,0.665920096530103,0.669304815469786,0.672690362702806,0.676073225569453,0.679449891410018,0.682816847564791,0.686170581374063,0.689507580178123,0.692824331317264,0.696117322131774,0.699383039961944,0.702617972148065,0.705818982081166,0.708987033138842,0.712125610346089,0.715238235539415,0.718328430555329,0.721399717230337,0.724455617400948,0.727499652903670,0.730535345575011,0.733566217251478,0.736595789769579,0.739627584965822,0.742665124676716,0.745711930738767,0.748771524988484,0.751847429262375,0.754943165396947,0.758062255228708,0.761208220594166,0.764384583329830,0.767594865272206,0.770842588257804,0.774131274123129,0.777464444704691,0.780845621838998,0.784278327362557,0.787766083111875,0.791312410923462,0.794920832633825,0.798594870079471,0.802338045096908,0.806153879522645,0.810044718554586,0.814006165712406,0.818031427681144,0.822113708261215,0.826246211253032,0.830422140457011,0.834634699673565,0.838877092703110,0.843142523346060,0.847424195402829,0.851715312673832,0.856009078959484,0.860298698060199,0.864577373776391,0.868838309908475,0.873074710256866,0.877279778621979,0.881446718804227,0.885568734604025,0.889639029821788,0.893650808257930,0.897597273712866,0.901471629987010,0.905267080880778,0.908976830194582,0.912594081728839,0.916112039283962,0.919523906660366,0.922822887658466,0.926002186078675,0.929055005721410,0.931974551926059,0.934757250757235,0.937409536301018,0.939939780893180,0.942356356869493,0.944667636565727,0.946881992317654,0.949007796461045,0.951053421331672,0.953027239265305,0.954937622597716,0.956792943664676,0.958601574801957,0.960371888345329,0.962112256630565,0.963831051993434,0.965536646769710,0.967237413295162,0.968941723905562,0.970657950936681,0.972394466724291,0.974159643604163,0.975961853912068,0.977809469983778,0.979710864155063,0.981674408761695,0.983708476139446,0.985821438624086,0.988021668551387,0.990317536712366,0.992713117379880,0.995198805585841,0.997762280046762,1.00039121947916,1.00307330259954,1.00579620812442,1.00854761477032,1.01131520125375,1.01408664629123,1.01684962859926,1.01959182689436,1.02230091989304,1.02496458631183,1.02757050486723,1.03010635427575,1.03255981325392,1.03491856051824,1.03717027478523,1.03930263477140,1.04130331919326,1.04316000676734,1.04486037621014,1.04639210623818,1.04774287556797,1.04890199507631,1.04987299069391,1.05066671149957,1.05129406721072,1.05176596754479,1.05209332221919,1.05228704095135,1.05235803345868,1.05231720945860,1.05217547866855,1.05194375080593,1.05163293558817,1.05125394273268,1.05081768195690,1.05033506297824,1.04981699551412,1.04926973518377,1.04866852449537,1.04797592754140,1.04715447057812,1.04616667986173,1.04497508164848,1.04354220219458,1.04183056775628,1.03980270458980,1.03742113895138,1.03464839709723,1.03144700528359,1.02777948976669,1.02360837680277,1.01889619264804,1.01361527750706,1.00780160150367,1.00151650869052,0.994821408978394,0.987777712278090,0.980446828500395,0.972890167556098,0.965169139355988,0.957345153810855,0.949479620831487,0.941633950328674,0.933869552213206,0.926247836395872,0.918830212787462,0.911678091298764,0.904852881840569,0.898415994323665,0.892408682195701,0.886778442992633,0.881445535178485,0.876330214237843,0.871352735655288,0.866433354915404,0.861492327502774,0.856449908901980,0.851226354597607,0.845741920074236,0.839916860816451,0.833671432308834,0.826925890035970,0.819600489482440,0.811615486132828,0.802914571515584,0.793553295188746,0.783620541970074,0.773205202382334,0.762396166948297,0.751282326190730,0.739952570632403,0.728495790796083,0.717000877204540,0.705556720380541,0.694252210846857,0.683170486346959,0.672328020543263,0.661698378455596,0.651254414458843,0.640968982927889,0.630814938237618,0.620765134762915,0.610792426878665,0.600869668959751,0.590969715381060,0.581065420517475,0.571129638743881,0.561135224435163,0.551055031966205,0.540861915711893,0.530530389763513,0.520056395865736,0.509450785530853,0.498724712423787,0.487889330209457,0.476955792552783,0.465935253118688,0.454838865572091,0.443677783577914,0.432463160801077,0.421206150906501,0.409917907559108,0.398609584423817,0.387292335165549,0.375977313449226,0.364675672939769,0.353398567302096,0.342157150201131,0.330963517958270,0.319837049994689,0.308800518042066,0.297876712776332,0.287088424873415,0.276458445009245,0.266009563859750,0.255764572100858,0.245746260408500,0.235977419458604,0.226480839927098,0.217279312489913,0.208395627822976,0.199852576602217,0.191670078165120,0.183838066569047,0.176328628989360,0.169113615767375,0.162164877244410,0.155454263761782,0.148953625660809,0.142634813282808,0.136469676969096,0.130430067060989,0.124487833899807,0.118614827826866,0.112782899183482,0.106963898310974,0.101129675550659,0.0952554067230001,0.0893525000201456,0.0834546365519107,0.0775958221000569,0.0718100624463448,0.0661313633725360,0.0605937306603918,0.0552311700916739,0.0500776874481428,0.0451672885115600,0.0405339790636870,0.0362117648862853,0.0322337055865734,0.0286102581789040,0.0253287999927826,0.0223756667517256,0.0197371941792489,0.0173997179988689,0.0153495739341018,0.0135730977084641,0.0120566250454717,0.0107864916686410,0.00974903330148818,0.00893058566752956,0.00831748449028126,0.00789606549325959,0.00765266439998077,0.00757361693396106,0.00764525881871668,0.00785392577776387,0.00818595353461887,0.00862767781279788,0.00916543433581721,0.00978555882719306,0.0104743870104416,0.0112182546090792,0.0120034973466221,0.0128164509465863,0.0136434511324884,0.0144708336278443,0.0152850746913917,0.0160782494408100,0.0168497855149780,0.0175996100037831,0.0183276499971123,0.0190338325848530,0.0197180848568924,0.0203803339031177,0.0210205068134161,0.0216385306776749,0.0222343325857812,0.0228078396276223,0.0233589788930855,0.0238876774720580,0.0243938624544270,0.0248774609300797,0.0253383999889033,0.0257766067207852,0.0261920082156124,0.0265845315632723,0.0269541038536520,0.0273006521766389,0.0276241036221201,0.0279243852799828,0.0282014242401143,0.0284551475924018,0.0286854824267326,0.0288923558329938,0.0290756949010727,0.0292354267208566,0.0293714783822326,0.0294837769750880,0.0295722495893099,0.0296368233147858,0.0296774252414027,0.0296940627941163,0.0296874288501026,0.0296585634724909,0.0296085094265084,0.0295383094773823,0.0294490063903398,0.0293416429306080,0.0292172618634141,0.0290769059539853,0.0289216179675488,0.0287524406693317,0.0285704168245612,0.0283765891984646,0.0281720005562689,0.0279576936632014,0.0277347112844892,0.0275040961853596,0.0272668911310396,0.0270241388867566,0.0267768822177376,0.0265261638892097,0.0262730266664004,0.0260185133145365,0.0257636665988455,0.0255095292845544,0.0252571441368904,0.0250075539210807,0.0247618014023525,0.0245209293459329,0.0242859805170492,0.0240579976809285,0.0238380236027980,0.0236271010478848,0.0234262727814161,0.0232365815686192,0.0230590701747212,0.0228947813649493,0.0227447579045306,0.0226100311918806,0.0224910797458322,0.0223875921192531,0.0222991961799297,0.0222255197956490,0.0221661908341974,0.0221208371633617,0.0220890866509287,0.0220705671646849,0.0220649065724170,0.0220717327419118,0.0220906735409559,0.0221213568373360,0.0221634104988388,0.0222164623932510,0.0222801403883592,0.0223540723519502,0.0224378861518105,0.0225312096557270,0.0226336707314863,0.0227448972468750,0.0228645170696799,0.0229921580676876,0.0231274481086848,0.0232700150604583,0.0234194867907946,0.0235754911674805,0.0237376560583026,0.0239056093310477,0.0240789788535024,0.0242573924934534,0.0244404781186874,0.0246278635969910,0.0248191767961510,0.0250140455839540,0.0252120978281868,0.0254129613966359,0.0256162641570881,0.0258216339773301,0.0260286987251486,0.0262370862683301,0.0264464244746615,0.0266563412119294,0.0268664643479205,0.0270764217504214,0.0272858412872189,0.0274943508260996,0.0277015785378547,0.0279071581971203,0.0281107285148535,0.0283119283708379,0.0285103966448568,0.0287057722166938,0.0288976939661321,0.0290858007729552,0.0292697315169467,0.0294491250778898,0.0296236203355680,0.0297928561697648,0.0299564714602636,0.0301141050868478,0.0302653959293008,0.0304099828674061,0.0305475047809470,0.0306776005497071,0.0307999090534697,0.0309140691720184,0.0310197197851364,0.0311164997726072,0.0312040480142144,0.0312820033897412,0.0313500047789711,0.0314076910616876,0.0314547011176741,0.0314906738267139,0.0315152480685906,0.0315280627230876,0.0315287566699883,0.0315169687890760,0.0314923379601344,0.0314545030629466,0.0314031029772964,0.0313377765829669,0.0312583247346604,0.0311652595352805,0.0310592882553486,0.0309411181707309,0.0308114565572935,0.0306710106909026,0.0305204878474242,0.0303605953027246,0.0301920403326698,0.0300155302131261,0.0298317722199595,0.0296414736290363,0.0294453417162225,0.0292440837573844,0.0290384070283879,0.0288290188050995,0.0286166263633850,0.0284019369791107,0.0281856579281428,0.0279684964863474,0.0277511599295906,0.0275343555337386,0.0273187905746575,0.0271051723282135,0.0268942080702727,0.0266866050767013,0.0264830706233653,0.0262843119861311,0.0260910364408646,0.0259039512634320,0.0257237637296996,0.0255511811155334,0.0253869106967996,0.0252316597493643,0.0250861355490937,0.0249510453718539,0.0248270964935110,0.0247149961899313,0.0246154517369809,0.0245291704105258,0.0244567977939853,0.0243983519997461,0.0243534852075512,0.0243218450293239,0.0243030790769873,0.0242968349624646,0.0243027602976790,0.0243205026945538,0.0243497097650121,0.0243900291209771,0.0244411083743720,0.0245025951371201,0.0245741370211446,0.0246553816383685,0.0247459766007153,0.0248455695201079,0.0249538080084697,0.0250703396777239,0.0251948121397936,0.0253268730066020,0.0254661698900725,0.0256123504021281,0.0257650621546920,0.0259239527596876,0.0260886698290378,0.0262588609746661,0.0264341738084956,0.0266142559424494,0.0267987549884508,0.0269873185584229,0.0271795942642891,0.0273752297179725,0.0275738725313962,0.0277751703164835,0.0279787706851577,0.0281843212493418,0.0283914695433496,0.0285998439065518,0.0288090284200233,0.0290186009480162,0.0292281393547828,0.0294372215045754,0.0296454252616459,0.0298523284902468,0.0300575090546303,0.0302605448190484,0.0304610136477534,0.0306584934049976,0.0308525619550331,0.0310427971621121,0.0312287768904868,0.0314100790044095,0.0315862813681324,0.0317569618459075,0.0319216983019873,0.0320800686006238,0.0322316506060692,0.0323760221825758,0.0325127611943958,0.0326414455057814,0.0327616529809847,0.0328729614842580,0.0329749488798536,0.0330671930320235,0.0331492718050200,0.0332207630630954,0.0332812446705017,0.0333302944914912,0.0333674903903162,0.0333924102312288,0.0334046318784812,0.0334037331963257,0.0333892920490144,0.0333608863007996,0.0333180938159334,0.0332604924586680,0.0331876600932557,0.0330991745839487,0.0329946137949991,0.0328735559702296,0.0327358993567150,0.0325824439607390,0.0324141474838490,0.0322319676275921,0.0320368620935153,0.0318297885831660,0.0316117047980913,0.0313835684398384,0.0311463372099544,0.0309009688099866,0.0306484209414820,0.0303896513059879,0.0301256176050514,0.0298572775402198,0.0295855888130402,0.0293115091250598,0.0290359961778257,0.0287600076728851,0.0284845013117852,0.0282104347960733,0.0279387658272963,0.0276704521070016,0.0274064513367363,0.0271477212180476,0.0268952194524826,0.0266499037415886,0.0264127317869126,0.0261846612900020,0.0259666499524037,0.0257596554756652,0.0255646355613334,0.0253825479109556,0.0252143502260790,0.0250610002082507,0.0249234555590179,0.0248026739799279,0.0246996131725276,0.0246152308383644,0.0245504846789854,0.0245063323959378,0.0244837316907688,0.0244836402650255,0.0245070158202551,0.0245548160580048,0.0246279986798218,0.0247275213872532,0.0248543418818462,0.0250094178651480,0.0251937070387058,0.0254081671040667,0.0256537557627779,0.0259314307163866,0.0262421496664401,0.0265868703144853,0.0269665503620695,0.0273821475107400,0.0278346194620438};

#endif	//(CONTROL_STRATEGY == RUN_TORQUE_TRACKING)




// initialize parameters to track sensor values, actuate the motors

struct actuation_parameters act_para =
	{
	.ankleTorqueMeasured=0,.ankleTorqueDesired=0,.ankleHeight=0,.ankleVel=0,.ankleAcc=0,\
	.cableTensionForce=0,.motorTorqueMeasured=0,.motorTorqueDesired=0,.motorCurrentMeasured=0,\
	.motorCurrentDesired=0,.initialMotorPosition=0,.currentMotorPosition=0,\
	.motorRelativeRevolution=0,.motorRotationAngle=0,.motorAngularVel=0,.motorAngularAcc=0,\
	.boardTemperature=0,.safetyFlag=0,.currentOpLimit=0
	}; 	//zero initialization




//SAFETY FLAGS - in addition to enum, so can be cleared but don't lose other flags that may exist.
	static int8_t isSafetyFlag = 0;
	static int8_t isPositionLimit = 0;
	static int8_t isTorqueLimit = 0;
	static int8_t isCurrentLimit = 0;
	static int8_t isAngularVelLimit = 0;
	static int8_t isTempLimit = 0;

	int8_t isEnabledUpdateSensors = 0;
	int32_t currentOpLimit = MOTOR_CURRENT_LIMIT; 	//operational limit for current.
	static const float bLimit		= B_ANGLE_LIMIT;

//torque gain values
	float torqueKp = TORQ_KP_INIT;
	float torqueKi = TORQ_KI_INIT;
	float torqueKd = TORQ_KD_INIT;
	_Bool isClearErrorIntegral = 0;

//current gain values
	int16_t currentKp = ACTRL_I_KP_INIT;
	int16_t currentKi = ACTRL_I_KI_INIT;
	int16_t currentKd = ACTRL_I_KD_INIT;



//****************************************************************************
// Private Function Prototype(s):
//****************************************************************************
void stateTransition(void);
void trackTorque(void);
void checkInvalidGait(void);
void getMortorKinematics(struct actuation_parameters *actx);
void getAnkleKinematics(struct actuation_parameters *actx);
void getAnkleTorque(struct actuation_parameters *actx);
void getMotorTorque(struct actuation_parameters *actx);
void setAnkleTorque(struct actuation_parameters *actx, float tau_desired);
//****************************************************************************
// Public Function(s)
//****************************************************************************


//Prepare the system:
void init_runningExo(void)
//TODO
{
	fsm1State = 0;
	runningExoState.state = 1;					//Initialize state
	controlAction = 0;			//clear control action
	act_para.initialMotorPosition = *rigid1.ex.enc_ang; // test if it is correct using GUI
	act_para.currentMotorPosition = *rigid1.ex.enc_ang;
}

//Running Exo state machine
void RunningExo_fsm_1(void)
//TODO
{
	#if (CONTROL_STRATEGY == TORQUE_TRACKING)
	//Torque Trajectory Tracking
	//Update states
	stateTransition();
	//check for impossible gaits
	checkInvalidGait();
	//Perform actions
	switch (runningExoState.state)
	{
		case HEEL_STRIKE:
			//Gait cycle is between heel strike and toe off
			trackTorque();
			break;

		case FOOT_FLAT:
			//Foot flat is irrelevant in trajectory tracking
			trackTorque();
			break;

		case SWING_PHASE:
			//Swing phase
			controlAction = 0;					//no force output
			break;
	}
	runningExoState.timer+=1;					//increase timer
	controlAction *= (int)runningExoState.enableOutput;			//safety check
	#endif //CONTROL_STRATEGY == TORQUE_TRACKING
	rigid1.mn.genVar[0]=runningExoState.state;
	rigid1.mn.genVar[1]=runningExoState.footFlatTime;
	rigid1.mn.genVar[2]=runningExoState.pedometer;
	rigid1.mn.genVar[3]=controlAction;
	//Time stamps
	rigid1.mn.genVar[4]= runningExoState.heelStrikeTime;
	rigid1.mn.genVar[5]= act_para.initialMotorPosition;
	rigid1.mn.genVar[6]= runningExoState.prevStanceDuration;
	rigid1.mn.genVar[7]= runningExoState.prevGaitDuration;
	rigid1.mn.genVar[8]= runningExoState.enableOutput;
	rigid1.mn.genVar[9]= runningExoState.disabledPedometer;
}

//Second state machine for the Running Exo
void RunningExo_fsm_2(void)
{

}

//****************************************************************************
// Private Function(s)
//****************************************************************************
void stateTransition(void)
//Computes the current state
{
	//TODO: Add debounce filtering

	switch(runningExoState.state)
	{
		case SWING_PHASE:
			//State Transition
			if(rigid1.mn.analog[FOOTSWITCH_HEEL]>HEEL_STRIKE_THRESHOLD)
			{
				if (runningExoState.disabledPedometer>=DISABLED_STEPS)
					runningExoState.enableOutput=1;
				runningExoState.state = HEEL_STRIKE;
				runningExoState.prevGaitDuration=runningExoState.timer-runningExoState.heelStrikeTime;
				runningExoState.heelStrikeTime=runningExoState.timer;
				//Count steps at the end of each swing phase
				runningExoState.pedometer+=1;
				if(!runningExoState.enableOutput)
					runningExoState.disabledPedometer+=1;			//count
				else
					runningExoState.disabledPedometer = 0;
			}

			break;

		case HEEL_STRIKE:
			//State Transition
			if((rigid1.mn.analog[FOOTSWITCH_TOE]>FOOT_FLAT_THRESHOLD ||
						rigid1.mn.analog[FOOTSWITCH_LATERAL]>FOOT_FLAT_THRESHOLD ||
						rigid1.mn.analog[FOOTSWITCH_MEDIAL]>FOOT_FLAT_THRESHOLD)&&
						rigid1.mn.analog[FOOTSWITCH_HEEL]>FOOT_FLAT_THRESHOLD)
			{
				runningExoState.state = FOOT_FLAT;
				runningExoState.footFlatTime=runningExoState.timer;
			}
			break;

		case FOOT_FLAT:
			if((rigid1.mn.analog[FOOTSWITCH_TOE]<TOE_OFF_THRESHOLD &&
			rigid1.mn.analog[FOOTSWITCH_LATERAL]<TOE_OFF_THRESHOLD &&
			rigid1.mn.analog[FOOTSWITCH_MEDIAL]<TOE_OFF_THRESHOLD)&&
			rigid1.mn.analog[FOOTSWITCH_HEEL]<TOE_OFF_THRESHOLD)
			{
				runningExoState.state = SWING_PHASE;
				runningExoState.toeOffTime=runningExoState.timer;
				runningExoState.prevStanceDuration=runningExoState.timer-runningExoState.heelStrikeTime;
			}
			break;
	}
}
//
//    //detect heel-strike moment: transition from a swing phase to a stance phase, i.e.,  swingPhaseFlag = 1 -> 0
//	if (stateMachine.swingPhaseFlag == 1 && stateMachine.RearfootPressure_2 > HEEL_STRIKE_THRESHOLD && stateMachine.dRearfootPressure > dHEEL_STRIKE_THRESHOLD)
//	{
//		stateMachine.heelStrikeFlag = 1;
//		stateMachine.toeOffFlag = 0;
//		stateMachine.footFlatFlag = 0;
//		stateMachine.stancePhaseFlag = 1;
//		stateMachine.swingPhaseFlag = 0;
//	    stateMachine.swingPeriod = stateMachine.swingTimer; //save the result of the counter in the previous swing phase
//	    stateMachine.stanceTimer = 0;
//	    stateMachine.swingTimer = 0; //reset the swing timer
//	}
//
//	//detect toe-off moment: transition from a stance phase to a swing phase, i.e., stancePhaseFlat(footNo) = 1 -> 0
//	else if (stateMachine.stancePhaseFlag == 1  && stateMachine.ForefootPressure_2 < TOE_OFF_THRESHOLD && stateMachine.dForefootPressure < dTOE_OFF_THRESHOLD && stateMachine.footFlatFlag == 1)
//	{
//		stateMachine.toeOffFlag = 1;
//		stateMachine.heelStrikeFlag = 0;
//		stateMachine.footFlatFlag = 0;
//		stateMachine.stancePhaseFlag = 0;
//		stateMachine.swingPhaseFlag = 1;
//		stateMachine.stancePeriod = stateMachine.stanceTimer; //save the result of the counter in the previous stance phase
//		stateMachine.swingTimer = 0;
//		stateMachine.stanceTimer = 0; //reset the stance timer
//
//	}
//
//	// detect swinging (can detect late or early swing?)
//	else if (stateMachine.toeOffFlag == 1  && stateMachine.ForefootPressure_2 < TOE_OFF_THRESHOLD &&  stateMachine.RearfootPressure_2 < HEEL_STRIKE_THRESHOLD)
//	{
//		stateMachine.swingPhaseFlag = 1;
//		stateMachine.stancePhaseFlag = 0;
//		stateMachine.footFlatFlag = 0;
//	}
//
//	// detect stance - foot flat (can distinguish true foot-flat or false Push-off?)
//	else if (stateMachine.ForefootPressure_2 > TOE_OFF_THRESHOLD && stateMachine.RearfootPressure_2 > HEEL_STRIKE_THRESHOLD)
//	{
//		stateMachine.stancePhaseFlag = 1;
//		stateMachine.swingPhaseFlag = 0;
//		stateMachine.footFlatFlag = 1;
//	}
	//---------------------------- end of  gait transition detection-----------------------------------

	//-----------------------------------------stance phase--------------------------------------------
//	if (stateMachine.stancePhaseFlag == 1)
//	{
//		//update the current state and run the counter
//		stateMachine.groundTouchFlag = 1;
//		stateMachine.stanceTimer = stateMachine.stanceTimer + 1;
//
//		//check  whether the prior recorded stance period is reasonable,  swing and stance phases have to be shorter than 2 sec
//		if (stateMachine.swingPeriod > GAIT_PERIOD_THRESHOLD_FLOOR && stateMachine.swingPeriod < GAIT_PERIOD_THRESHOLD_CEILING && stateMachine.stancePeriod > GAIT_PERIOD_THRESHOLD_FLOOR && stateMachine.stancePeriod < GAIT_PERIOD_THRESHOLD_CEILING)
//		{
//			stateMachine.normalWalkingFlag = 1;
//
//			//find out the number of the walking steps when the controller fires
//			if (stateMachine.heelStrikeFlag == 1)
//			{
//				stateMachine.stepCounter = stateMachine.stepCounter + 1;
//				stateMachine.newStepFlag = 1;
//				stateMachine.heelStrikeFlag = 0;
//			}
//			else
//			{
//				stateMachine.postHeelStrikeFlag = 1;
//				stateMachine.postToeOffFlag = 0;
//			}
//
//			stateMachine.gaitCycle = (float)stateMachine.stanceTimer/(float)(stateMachine.stancePeriod + stateMachine.swingPeriod) > 1 ? 1:(float)stateMachine.stanceTimer/(float)(stateMachine.stancePeriod + stateMachine.swingPeriod);
//		}   //if (stateMachine.swingPeriod > GAIT_PERIOD_THRESHOLD_FLOOR && stateMachine.swingPeriod < GAIT_PERIOD_THRESHOLD_CEILING && stateMachine.stancePeriod > GAIT_PERIOD_THRESHOLD_FLOOR && stateMachine.stancePeriod < GAIT_PERIOD_THRESHOLD_CEILING)
//
//		else
//		{
//	        stateMachine.normalWalkingFlag = 0;
//	        stateMachine.gaitCycle = 0;
//	        currentTorqueValue = 0;
//			stateMachine.stepCounter = 0;     // reset the step counter
//		}
//
//	} // if (stateMachine.stancePhaseFlag == 1)
//
//	else if (stateMachine.swingPhaseFlag == 1)
//	{
//		//powerAssistProfile = 0;
//		stateMachine.groundTouchFlag = 0;
//		stateMachine.swingTimer = stateMachine.swingTimer + 1;
//
//		//check whether the prior recorded swing period is reasonable
//		if (stateMachine.stancePeriod > GAIT_PERIOD_THRESHOLD_FLOOR && stateMachine.stancePeriod < GAIT_PERIOD_THRESHOLD_CEILING && stateMachine.swingPeriod > SWING_PERIOD_THRESHOLD_FLOOR && stateMachine.stepCounter >0)
//		{
//			stateMachine.normalWalkingFlag = 1;
//
//			if (stateMachine.toeOffFlag == 1)
//			{
//				stateMachine.newStepFlag = 0;
//
//			}
//			else
//			{
//				stateMachine.postToeOffFlag = 1;
//				stateMachine.postHeelStrikeFlag = 0;
//			}
//
//			stateMachine.gaitCycle = (float)(stateMachine.swingTimer + stateMachine.stancePeriod)/(float)(stateMachine.stancePeriod + stateMachine.swingPeriod) > 1 ? 1:(float)(stateMachine.swingTimer + stateMachine.stancePeriod)/(float)(stateMachine.stancePeriod + stateMachine.swingPeriod);
//		}
//
//		else
//		{
//			stateMachine.normalWalkingFlag = 0;
//			stateMachine.gaitCycle = 0;
//		}
//
//	}
//
//	else
//	{
//		stateMachine.normalWalkingFlag = 0;
//		stateMachine.gaitCycle = 0;
//		stateMachine.stanceTimer = 0;
//		stateMachine.swingTimer = 0;
//
//	}
//
//
//}

void trackTorque(void)
//sets control output based on trajectory tracking
{
	static float percentStance = 0;
	static float lastPercentageStance = 0;
	uint16_t lastIndex = 0;
	uint16_t currentIndex = 0;
	lastPercentageStance = percentStance;
	lastIndex = (int)(lastPercentageStance*(float)TABLE_SIZE);
	percentStance = (float)(runningExoState.timer-runningExoState.heelStrikeTime)/(float)runningExoState.prevStanceDuration>1 ? 1:(float)(runningExoState.timer-runningExoState.heelStrikeTime)/(float)runningExoState.prevStanceDuration;//range=[0,1]
	currentIndex = (int)(percentStance*(float)TABLE_SIZE);
	float torqueValue = 0;

	if(currentIndex != lastIndex)
	{
		isClearErrorIntegral = 1;
	}
	else
	{
		isClearErrorIntegral = 0;
	}

	if (runningExoState.running)
	{
		#ifdef RUNNING_TORQUE_TRACKING
			torqueValue = unitRunningTorque[currentIndex]*bodyWeight*torqueProfileGain;
		#endif
	}
	else
	{
		#ifdef WALKING_TORQUE_TRACKING
			torqueValue = unitWalkingTorque[currentIndex]*bodyWeight*torqueProfileGain;
		#endif
	}

	//Set motor output
	//TODO: Unit conversion and casting
	controlAction=torqueValue;
}

void checkInvalidGait(void)
{
	//gait too long
	if (runningExoState.timer-runningExoState.heelStrikeTime > MAX_STANCE_PERIOD)
	{
		//disable output
		runningExoState.enableOutput = 0;
		runningExoState.disabledPedometer = 0;
	}

}


/*
 * Check for safety flags, and act on them.
 * todo: come up with correct strategies to deal with flags, include thermal limits also
 */
int8_t safetyShutoff(void) {

	switch(isSafetyFlag)

	{
		case SAFETY_OK:

			return 0;

		case SAFETY_TEMPERATURE:
			//check if flag is not still active to be released, else do something about problem.
			if( !isTempLimit )
			{
				currentOpLimit = MOTOR_CURRENT_LIMIT;		// return to full power todo: may want to gradually increase
				isSafetyFlag = SAFETY_OK;
				break;
			}
			else
			{
				if (currentOpLimit > 0)
				{
					currentOpLimit--;	//reduce current limit every cycle until we cool down.
				}
			}

			return 0; //continue running FSM

		case SAFETY_MOTOR_VELOCITY:
					//check if flag is not still active to be released, else do something about problem.
			if(!isAngularVelLimit)
			{
				isSafetyFlag = SAFETY_OK;
				break;
			}
			else
			{
				setMotorCurrent(0); // this might happen when no load under torque control mode. turn off motor. might need something better than this.
			}

			return 1;

		case SAFETY_MOTOR_POSITION:
			//check if flag is not still active to be released, else do something about problem.
			if(!isPositionLimit)
			{
				isSafetyFlag = SAFETY_OK;
				break;
			}
			else
			{
				setMotorCurrent(0); // turn off motor. might need something better than this.
			}

			return 1;

		case SAFETY_ANKLE_TORQUE:

			//check if flag is not still active to be released, else do something about problem.
			if(!isTorqueLimit)
			{
				isSafetyFlag = SAFETY_OK;
				break;
			}
			else
			{
				setAnkleTorque(&act_para, act_para.ankleTorqueDesired*0.5); //run this in order to update torque genVars sent to Plan
			}

			return 1;


		default:
			return 1;
	}


	return 0;
}



/*
 * Collect all sensor values and update the actuator structure.
 * Throws safety flags on Joint Angle, Joint Torque, since these functions look at transformed values.
 */
void updateSensorValues(struct actuation_parameters *actx)
{
	getMortorKinematics(actx);
	getAnkleKinematics(actx);
	getAnkleTorque(actx);
	getMotorTorque(actx);

	actx->boardTemperature =  rigid1.re.temp;				//centidegree
	actx->motorCurrentMeasured = rigid1.ex.mot_current; 	//mA
	actx->currentOpLimit = currentOpLimit; 					// throttled mA

	actx->safetyFlag = isSafetyFlag;

	if(actx->boardTemperature > MAX_BOARD_TEMP)
	{
		isSafetyFlag = SAFETY_TEMPERATURE;
		isTempLimit = 1;
	} else {
		isTempLimit = 0;
	}

}

//get motor's kinematic parameters
void getMortorKinematics(struct actuation_parameters *actx)
{
	actx->currentMotorPosition = *rigid1.ex.enc_ang;
	actx->motorRelativeRevolution = (actx->currentMotorPosition - actx->initialMotorPosition) / ENCODER_CPR;
	actx->motorRotationAngle = actx->motorRelativeRevolution * 2 * M_PI;		//rad
	actx->motorAngularVel = (*rigid1.ex.enc_ang_vel/ENCODER_CPR) * 2 * M_PI;	//rad/s, need to times SECONDS?????
	actx->motorAngularAcc = (rigid1.ex.mot_acc/ENCODER_CPR) * 2 * M_PI;			//rad/s/s, need to check if the gain factor is needed

	 if(actx->motorRelativeRevolution >= MAX_MOTOR_REVOLUTION)
	 {
		isSafetyFlag = SAFETY_MOTOR_POSITION;
		isPositionLimit = 1;
	 }
	 else
	 {
		 isPositionLimit = 0;
	 }


	 if(actx->motorAngularVel >= MAX_MOTOR_SPEED)
	 {
		isSafetyFlag = SAFETY_MOTOR_VELOCITY;
		isAngularVelLimit = 1;
	 }
	 else
	 {
		isAngularVelLimit = 0;
	 }

}

//get ankle's kinematic parameters
void getAnkleKinematics(struct actuation_parameters *actx)
{
	actx->ankleHeight = actx->motorRelativeRevolution * MOT_OUTPUT_SHAFT_PERIMETER; // not so accurate, used for estimating, because the wrapping diameter will change after some revolutions.
	actx->ankleVel = actx->motorAngularVel * (MOT_OUTPUT_SHAFT_PERIMETER/2);		//m/s
	actx->ankleAcc = actx->motorAngularAcc * (MOT_OUTPUT_SHAFT_PERIMETER/2);		//m/s/s
}


//Determine torque at ankle
void getAnkleTorque(struct actuation_parameters *actx)
{
	 actx->ankleTorqueMeasured = ANKLE_TORQUE_CALIB_M * rigid1.ex.strain + ANKLE_TORQUE_CALIB_B; //N.m

	 if(actx->ankleTorqueMeasured >= MAX_ANKLE_TORQUE)
	 {
		isSafetyFlag = SAFETY_ANKLE_TORQUE;
		isTorqueLimit = 1;
	 }
	 else
	 {
		isTorqueLimit = 0;
	 }

}


//Determine torque at motor
void getMotorTorque(struct actuation_parameters *actx)
{
	actx->cableTensionForce = FORCE_CALIB_M * rigid1.ex.strain + FORCE_CALIB_B;
	actx->motorTorqueMeasured = actx->cableTensionForce * (MOT_OUTPUT_SHAFT_DIAMETER/2);
}



void setAnkleTorque(struct actuation_parameters *actx, float tau_desired_ankle)
{
	float tau_measured = 0, tau_desired = 0, tau_ff = 0;  	//joint torque reflected to motor. Feed forward term for desired joint torque, reflected to motor [Nm]
	float tau_error = 0;
	static float tau_error_last = 0, tau_error_integral = 0;
	float tau_PID = 0, tau_error_diff = 0, tau_motor_compensation = 0;		// motor torque signal
	int32_t dtheta_m = 0, ddtheta_m = 0;		//motor angular velocity and acceleration
	int32_t I = 0;								// motor current signal

	dtheta_m = actx->motorAngularVel;  	//rad/s
	ddtheta_m = actx->motorAngularAcc;	//rad/s/s

	actx->ankleTorqueDesired = tau_desired_ankle;		// save in case need to modify in safetyFailure()
	actx->motorTorqueDesired = (actx->ankleTorqueDesired/MOMENT_ARM_ON_FOOT) * (MOT_OUTPUT_SHAFT_DIAMETER/2);

	// todo: better fidelity may be had if we modeled N_ETA as a function of torque, long term goal, if necessary
	tau_measured = actx->motorTorqueMeasured;	// measured torque reflected to motor [Nm]
	tau_desired = actx->motorTorqueDesired;		// output torque back to the motor [Nm].
	tau_ff = tau_desired / (N_ETA) ;		// Feed forward term for desired joint torque, reflected to motor [Nm]

	tau_motor_compensation = (MOT_J + MOT_TRANS)*ddtheta_m + MOT_B*dtheta_m;	// compensation for motor parameters. not stable right now.

	// Error is done at the motor. todo: could be done at the ankle, messes with our gains.
	tau_error = tau_desired - tau_measured;
	tau_error_diff = tau_error - tau_error_last;
	if (!isClearErrorIntegral)
	{
		tau_error_integral = tau_error_integral + tau_error;  // check if this method is correct
	}
	else
	{
		tau_error_integral = 0;
	}
	tau_error_last = tau_error;

	//PID around motor torque
	tau_PID = tau_error*torqueKp + tau_error_diff*torqueKd + tau_error_integral*torqueKi;

	I = 1/MOT_KT * ( tau_ff + tau_PID + tau_motor_compensation) * currentScalar;

	//account for deadzone current (unused due to instability). Unsolved problem according to Russ Tedrake.
//	if (abs(dtheta_m) < 3 && I < 0) {
//		I -= motSticNeg; //in mA
//	} else if (abs(dtheta_m) < 3 && I > 0) {
//		I += motSticPos;
//	}

//	if ( I < 0) {
//		I -= motSticNeg; //in mA
//	} else if ( I > 0) {
//		I += motSticPos;
//	}

	// add position, velocity, torque of the motor and ankle limit.


	//Soft angle limits with virtual spring. Raise flag for safety check.
	if (actx->motorRelativeRevolution <= 0  || actx->motorRelativeRevolution >= MAX_MOTOR_REVOLUTION)
	{
		isSafetyFlag = SAFETY_MOTOR_POSITION;
		isPositionLimit = 1;		//these are all redundant, choose if we want the struct thing.

		float angleDiff1 = actx->motorRelativeRevolution;
		float angleDiff2 = actx->motorRelativeRevolution - MAX_MOTOR_REVOLUTION;

		//Oppose motion using linear spring with damping
		if (actx->motorRelativeRevolution < 0)
		{
			if (abs(angleDiff1) < 3)
			{
				I -= currentOpLimit*(angleDiff1/3) + bLimit*actx->motorAngularVel;
			}
			else
			{
				I -= -currentOpLimit + bLimit*actx->motorAngularVel;
			}

		} else if (actx->motorRelativeRevolution - MAX_MOTOR_REVOLUTION > 0)
		{
			if (abs(angleDiff2) < 3)
			{
				I -= currentOpLimit*(angleDiff2/3) + bLimit*actx->motorAngularVel;
			}
			else
			{
				I -= currentOpLimit + bLimit*actx->motorAngularVel;
			}
		}

	}
	else
	{

		isPositionLimit = 0;

	}

	//Saturate I for our current operational limits -- limit can be reduced by safetyShutoff() due to heating
	if (I > currentOpLimit)
	{
		I = currentOpLimit;
	}
	else if (I < -currentOpLimit)
	{
		I = -currentOpLimit;
	}

	actx->motorCurrentDesired = (int32_t) I; 	// demanded mA
	setMotorCurrent(actx->motorCurrentDesired);	// send current command to comm buffer to Execute

	//variables used in cmd-rigid offset 5
	rigid1.mn.userVar[5] = tau_measured*1000;
	rigid1.mn.userVar[6] = tau_desired*1000;

}



/*
 * Simple impedance controller
 * input:	theta_set, desired theta (degrees)
 * 			m,b,k impedance parameters
 * return: 	tor_d, desired torque
 */
float calcImpedanceTorque(float m, float b, float k, float ddthetad_set, float dtheta_set, float theta_set)
{
	float theta = 0, dtheta = 0, ddtheta = 0;
	float tor_d = 0;

	theta = act_para.currentMotorPosition;
	dtheta = act_para.motorAngularVel;
	ddtheta = act_para.motorAngularAcc;
	tor_d = m * (ddthetad_set - ddtheta) + b * (dtheta_set - dtheta) + k * (theta_set - theta);
//Todo, need to modify according to human running acceleration and velocity at foot
	return tor_d;

}


void mit_init_current_controller(void)
{

	setControlMode(CTRL_CURRENT);
	writeEx.setpoint = 0;			// wasn't included in setControlMode, could be safe for init
	setControlGains(currentKp, currentKi, currentKd, 0);

}


void packRigidVars(struct actuation_parameters  *actx)
{

	// set float userVars to send back to Plan
	rigid1.mn.userVar[0] = actx->cableTensionForce*1000;
	rigid1.mn.userVar[1] = actx->motorRelativeRevolution*1000;
	rigid1.mn.userVar[2] = actx->ankleHeight*1000;
	rigid1.mn.userVar[3] = actx->ankleTorqueMeasured*1000;
	rigid1.mn.userVar[4] = actx->ankleTorqueDesired*1000;

	//rigid1.mn.userVar[5] = tau_measured*1000;
	//rigid1.mn.userVar[6] = tau_desired*1000; (impedance controller - spring contribution)
}


#endif 	//defined BOARD_TYPE_FLEXSEA_MANAGE || defined BOARD_TYPE_FLEXSEA_PLAN

#endif 	//defined INCLUDE_UPROJ_RUNNINGEXO || defined BOARD_TYPE_FLEXSEA_PLAN


